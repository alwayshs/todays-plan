<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>오늘의 플랜</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <script src="https://js.tosspayments.com/v1"></script>
  <style>
    body {
      padding: 2rem;
      background-color: #f8f9fa;
    }
    #result {
      white-space: pre-wrap;
      min-height: 150px;
      background-color: #fff;
      border-radius: 0.375rem;
      border: 1px solid #ced4da;
      padding: 1rem;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-4">오늘의 플랜</h1>

    <div class="mb-3">
      <label for="interest" class="form-label">관심사</label>
      <input id="interest" class="form-control" placeholder="관심사를 입력하세요" />
    </div>

    <div class="mb-3">
      <label for="region" class="form-label">지역</label>
      <input id="region" class="form-control" placeholder="지역을 입력하세요" />
    </div>

    <div class="mb-3">
      <label for="goal" class="form-label">목표</label>
      <input id="goal" class="form-control" placeholder="목표를 입력하세요" />
    </div>

    <button id="generateBtn" class="btn btn-primary" type="button">생성하기</button>

    <pre id="result" class="mt-3"></pre>

    <hr />

    <button id="payButton" class="btn btn-success" type="button">결제하기 (토스페이)</button>
  </div>

  <script>
    const GEMINI_API_URL = '/api/generate';
    const CREATE_PAYMENT_URL = '/api/create-payment';

    async function init() {
      // 백엔드에서 토스 클라이언트 키 받아오기
      let tossClientKey = '';
      try {
        const configRes = await fetch('/api/config');
        const configData = await configRes.json();
        tossClientKey = configData.tossClientKey;
      } catch (e) {
        alert('토스 클라이언트 키를 불러오는데 실패했습니다.');
        console.error(e);
        return;
      }

      const tossPayments = TossPayments(tossClientKey);

      // AI 텍스트 생성
      document.getElementById('generateBtn').addEventListener('click', async () => {
        const interest = document.getElementById('interest').value.trim();
        const region = document.getElementById('region').value.trim();
        const goal = document.getElementById('goal').value.trim();

        if (!interest || !region || !goal) {
          alert('모든 입력란을 채워주세요.');
          return;
        }

        document.getElementById('generateBtn').disabled = true;
        document.getElementById('generateBtn').textContent = '생성 중...';

        try {
          const res = await fetch(GEMINI_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ interest, region, goal }),
          });

          if (!res.ok) throw new Error('API 응답 오류');

          const data = await res.json();
          document.getElementById('result').textContent = data.previewText;
        } catch (err) {
          alert(err.message);
          document.getElementById('result').textContent = '';
        } finally {
          document.getElementById('generateBtn').disabled = false;
          document.getElementById('generateBtn').textContent = '생성하기';
        }
      });

      // 토스 결제
      document.getElementById('payButton').addEventListener('click', async () => {
        const amount = 1000;
        const orderName = '오늘의 플랜 구독';

        document.getElementById('payButton').disabled = true;
        document.getElementById('payButton').textContent = '결제 준비 중...';

        try {
          const res = await fetch(CREATE_PAYMENT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ amount, orderName }),
          });

          if (!res.ok) throw new Error('결제 생성 실패');

          const data = await res.json();

          tossPayments.requestPayment('카드', {
            amount: data.amount,
            orderId: data.orderId,
            orderName: data.orderName,
            successUrl: data.successUrl,
            failUrl: data.failUrl,
          });
        } catch (err) {
          alert(err.message);
        } finally {
          document.getElementById('payButton').disabled = false;
          document.getElementById('payButton').textContent = '결제하기 (토스페이)';
        }
      });
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
